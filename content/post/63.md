+++
title = '도커 이미지 레이어의 모든 것: 개념부터 활용까지'
date = 2025-02-17T15:25:00+09:00
categories = ["Docker", "컨테이너"]
tags = ["Docker", "레이어", "이미지", "최적화"]
description = '도커 이미지 레이어의 개념과 동작 원리를 상세히 설명한다.'
draft = false
+++

## 이미지 레이어의 개념

도커 이미지는 하나의 큰 파일이 아니다. 여러 개의 작은 레이어로 구성된다. 각 레이어는 이전 레이어와의 파일 시스템 차이를 저장한다. 이는 마치 Git의 커밋처럼, 변경 사항만을 기록하는 방식이다.

간단한 예시로 이해해보자. 우분투 이미지 위에 nginx를 설치하는 과정은 다음과 같다:

1. 베이스 레이어: 우분투의 기본 파일 시스템
2. 변경 레이어: nginx 설치로 추가된 파일들
3. 설정 레이어: nginx 설정 파일의 변경 사항

## 레이어의 동작 방식

도커는 유니온 파일 시스템을 사용한다. 이는 여러 레이어를 하나의 파일 시스템으로 합치는 기술이다. 컨테이너가 실행될 때:

1. 모든 레이어는 읽기 전용이다
2. 컨테이너는 최상위에 읽기/쓰기 레이어를 추가한다
3. 파일 수정 시 copy-on-write 방식으로 동작한다

예를 들어 nginx 설정 파일을 수정하면:

1. 원본 파일은 읽기 전용 레이어에 있다
2. 수정된 파일은 읽기/쓰기 레이어에 복사된다
3. 이후 수정 사항은 읽기/쓰기 레이어에만 적용된다

## 레이어 생성과 저장

도커파일의 각 명령어는 새로운 레이어를 만든다:

```dockerfile
FROM ubuntu:20.04     # 레이어 1: 우분투 베이스 이미지
RUN apt-get update   # 레이어 2: 패키지 목록 업데이트
RUN apt-get install nginx  # 레이어 3: nginx 설치
COPY web /var/www/html    # 레이어 4: 웹 파일 복사
```

각 레이어는 다음 정보를 포함한다:

-   파일 시스템 변경 사항
-   메타데이터 (생성 시간, 명령어 등)
-   레이어 ID
-   부모 레이어 참조

## 레이어 공유와 재사용

도커의 강점은 레이어 공유에 있다. 동일한 베이스 이미지를 사용하는 여러 컨테이너는 해당 레이어를 공유한다:

1. 우분투 이미지: 100MB
2. nginx 설치: +50MB
3. 애플리케이션 A: +10MB
4. 애플리케이션 B: +10MB

이 경우 두 애플리케이션의 총 디스크 사용량은:

-   공유되지 않을 때: (100 + 50 + 10) \* 2 = 320MB
-   레이어 공유 시: 100 + 50 + 10 + 10 = 170MB

## 캐시 메커니즘의 이해

도커는 레이어 단위로 캐시를 관리한다. 빌드 시:

1. 각 명령어의 해시값을 계산한다
2. 동일한 해시의 레이어가 있으면 재사용한다
3. 캐시가 깨지면 이후 모든 단계를 재실행한다

이 때문에 도커파일의 명령어 순서가 중요하다:

```dockerfile
# 나쁜 예: 소스 변경시 npm install 재실행
COPY . /app
RUN npm install

# 좋은 예: package.json 변경시에만 npm install 실행
COPY package.json /app
RUN npm install
COPY . /app
```

## 레이어 수 최적화의 실제

레이어가 많을수록 이미지 크기와 성능에 영향을 준다. 최적화 예시:

```dockerfile
# 최적화 전: 3개 레이어
RUN apt-get update
RUN apt-get install python3
RUN apt-get clean

# 최적화 후: 1개 레이어
RUN apt-get update && \
    apt-get install python3 && \
    apt-get clean
```

레이어 수를 줄이는 것이 항상 좋은 것은 아니다. 캐시 활용과 유지보수성을 고려해야 한다.

## 레이어 조사와 분석

도커는 레이어 분석 도구를 제공한다:

```bash
# 레이어 히스토리 확인
docker history nginx:latest

# 레이어 상세 정보 확인
docker inspect nginx:latest
```

이를 통해:

-   각 레이어의 크기
-   생성 명령어
-   생성 시간
-   레이어 ID

를 확인할 수 있다.
